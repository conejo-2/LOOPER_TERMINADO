<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Looper - Game Over</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script src="supabaseClient.js"></script>
    <script src="get_record.js"></script>
</head>
<body class="modal-body">
    <div class="modal-overlay">
        <div class="modal-container gameover-modal">
            <h2 class="gameover-title">GAME OVER</h2>
            
            <div class="score-section">
                <div class="score-label">TU PUNTAJE ES:</div>
                <div class="score-value" id="finalScore">0</div>
                <div id="recordInfo"></div>
            </div>
            
            <div class="modal-buttons single">
            <button onclick="window.location.href='LOOPER_MENU.html'" class="modal-btn primary full-width">VOLVER AL MENÚ</button>
            <!-- botón modificado: ahora tiene id y no redirige directo -->
            <button id="btnVolverJugar" class="modal-btn secondary full-width">VOLVER A JUGAR</button>
            </div>
        </div>
    </div>

    <!-- Tutorial completion overlay -->
    <div id="tutorial-complete-backdrop" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.75);z-index:9999;align-items:center;justify-content:center;">
        <div style="background:#f5f5f5;color:#111;padding:20px;border-radius:10px;max-width:640px;margin:0 auto;text-align:center;">
            <h2>Tutorial completado</h2>
            <p>Ya puedes empezar a competir</p>
            <div style="margin-top:12px;"><button onclick="document.getElementById('tutorial-complete-backdrop').style.display='none'" class="modal-btn primary">Cerrar</button></div>
        </div>
    </div>

    <!-- NOTA: eliminé la inclusión de guardar_ranking.js y la llamada a guardarRanking desde aquí
         (el guardado debe ocurrir en LOOPER_JUEGO.html en el gameOver). -->

    <script>
        const params = new URLSearchParams(window.location.search);
        const puntaje = params.get('puntaje') || '0';
        const usuario = params.get('usuario') || '';
        const nuevo_record = params.get('nuevo_record') === "1";
        
        // --- INICIO DE MODIFICACIÓN 1 ---
        // Leemos el modo; si no viene, asumimos 'practica' por seguridad.
        const modoJuego = params.get('modo') || 'practica'; 
        // --- FIN DE MODIFICACIÓN 1 ---

        document.getElementById('finalScore').textContent = puntaje;

        // Mostrar récord si hay usuario
        if (usuario) {
            // (Esta parte queda igual)
            getRecord(usuario).then(record => {
                // ...
            });
        }

        // --- INICIO DE MODIFICACIÓN 2 ---
        // Botón "VOLVER A JUGAR" — Lógica actualizada
        document.getElementById('btnVolverJugar').addEventListener('click', () => {
            
            if (modoJuego === 'practica') {
                // ¡SOLUCIÓN! Si el modo era práctica, vuelve a práctica.
                window.location.href = 'LOOPER_JUEGO.html?modo=practica';
            } else { 
                // Lógica anterior (para modo 'ranked' o si 'modoJuego' es 'ranked')
                const lastUser = localStorage.getItem('usuario_looper') || usuario || '';
                if (lastUser) {
                    window.location.href = `LOOPER_JUEGO.html?modo=ranked&usuario=${encodeURIComponent(lastUser)}`;
                } else {
                    window.location.href = 'LOOPER_LOGIN.html';
                }
            }
        });
        // --- FIN DE MODIFICACIÓN 2 ---


        // --- INICIO DE MODIFICACIÓN 3 ---
        // Mostrar overlay de tutorial completado si vinimos del tutorial
        if (modoJuego === 'tutorial') { // Usamos la nueva variable modoJuego
            const back = document.getElementById('tutorial-complete-backdrop');
            if (back) {
                back.style.display = 'flex';
            }
            // If tutorial, hide the 'VOLVER A JUGAR' button
            const volverBtn = document.getElementById('btnVolverJugar');
            if (volverBtn) {
                volverBtn.style.display = 'none';
            }
        }
        // --- FIN DE MODIFICACIÓN 3 ---
    </script>

</body>
</html>
